name: CI

on:
  push:
  schedule:
    - cron: "0 7 * * 1,3,5"

env:
  CARGO_TERM_COLOR: always

jobs:
  sidecars:
    runs-on: ubuntu-latest
    services:
      dot-sidecar:
        image: parity/substrate-api-sidecar:latest
        env:
          SAS_SUBSTRATE_URL: wss://rpc.polkadot.io
          SAS_EXPRESS_PORT: 8080
        ports:
          - 8080:8080
      wnd-sidecar:
        image: parity/substrate-api-sidecar:latest
        env:
          SAS_SUBSTRATE_URL: wss://westend-rpc.polkadot.io
          SAS_EXPRESS_PORT: 8081
        ports:
          - 8081:8081
      ksm-sidecar:
        image: parity/substrate-api-sidecar:latest
        env:
          SAS_SUBSTRATE_URL: wss://kusama-rpc.polkadot.io
          SAS_EXPRESS_PORT: 8082
        ports:
          - 8082:8082
    steps:
      - name: Wait for Sidecar to be available
        run: |
          waitport() {
              while ! curl --fail --output 127.0.0.1:8080 ; do sleep 1 ; done
              while ! curl --fail --output 127.0.0.1:8081 ; do sleep 1 ; done
              while ! curl --fail --output 127.0.0.1:8082 ; do sleep 1 ; done
          }
          waitport
      - uses: actions/checkout@v2
      - name: Install latest nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
      - name: Run Integration Dryrun tests
        run: cargo test -- dry_run --test-threads=1 --ignored --nocapture
  nightly:
    runs-on: ubuntu-latest
    needs: sidecars
    steps:
      - uses: actions/checkout@v2
      - name: Install latest nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          components: rustfmt, clippy

      - name: Run rustfmt
        run: cargo fmt -- --check
      - name: Run clippy
        run: cargo clippy --verbose
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test -- --test-threads=1
  stable:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install latest nightly
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Build
        run: cargo build --verbose
